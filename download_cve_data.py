"""
This script preprocesses the raw data downloaded into a format that can be used for analysis.
Downloaded data from: https://vulners.com/search and edit accordingly data_sources list.
Edit main_source_dir to the directory where the downloaded data is stored.
"""
import os
import zipfile
import json
import pandas as pd
from tqdm import tqdm


def extract_json_from_zip(zip_path, output_dir):
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(output_dir)

    extracted_files = os.listdir(output_dir)
    json_files = [f for f in extracted_files if f.endswith('.json')]

    return os.path.join(output_dir, json_files[0])


def process_json_to_csv(json_path, csv_path):
    with open(json_path, 'r') as file:
        data = json.load(file)

    df = pd.json_normalize(data)
    df.to_csv(csv_path, index=False, compression='zip')


def remove_temp_files(temp_dir):
    for file in os.listdir(temp_dir):
        file_path = os.path.join(temp_dir, file)
        if os.path.isfile(file_path):
            os.remove(file_path)
    os.rmdir(temp_dir)

if __name__ == '__main__':

    data_sources = ['ibm', 'cve', 'redhatcve', 'redhat', 'packetstorm', 'osv', 'exploitdb']

    main_source_dir = "/Users/lyamin/Downloads"
    for data_source in tqdm(data_sources):
        data_path_json_zip = os.path.join(main_source_dir, f"{data_source}.json.zip")
        output_csv_path = os.path.join('raw_data', f"{data_source}.csv.zip")
        os.makedirs('raw_data', exist_ok=True)
        temp_dir = os.path.join(main_source_dir, f"{data_source}_temp")

        os.makedirs(temp_dir, exist_ok=True)

        json_path = extract_json_from_zip(data_path_json_zip, temp_dir)
        process_json_to_csv(json_path, output_csv_path)
        remove_temp_files(temp_dir)


